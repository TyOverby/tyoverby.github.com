



<!doctype html>

<html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta charset="UTF-8">
        <title> Heterogeneous Lists </title>
        <link href="https://fonts.googleapis.com/css?family=Montserrat:700|Raleway:100|Roboto+Condensed:300|Roboto|Roboto+Mono" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0-beta1/katex.min.css" integrity="sha384-VEnyslhHLHiYPca9KFkBB3CMeslnM9CzwjxsEbZTeA21JBm7tdLwKoZmCt3cZTYD" crossorigin="anonymous" />
        <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.9.0-beta1/katex.min.js" integrity="sha384-O4hpKqcplNCe+jLuBVEXC10Rn1QEqAmX98lKAIFBEDxZI0a+6Z2w2n8AEtQbR4CD" crossorigin="anonymous"></script>
        <style>

html, body, header {
    margin: 0;
    padding: 0;
}

header {
    position: relative;
    min-height: 100vh;

    background: url(../images/dark-field.jpeg);

    background-size: cover;
    text-align: center;

    display: flex;
    flex-direction: column;
    flex-wrap: wrap;
    justify-content: center;
    align-items: center;
}

header #header-container {
    background-color: red;
}

header #title {
    font-family: 'Montserrat', sans-serif;
    font-weight: bold;
    font-size: 3em;
    text-transform: uppercase;
}

header #subtitle {
    font-family: 'Raleway', sans-serif;
    font-weight: bold;
    font-size: 2em;
}

.black {
    color: black;
    text-shadow: 0px 0px 4px white;
}

.white {
    color: white;
    text-shadow: 0px 0px 4px black;
}

section {
    padding: 30px;
    font-family: 'Roboto', sans-serif;
    font-weight: 500;
    width: 800px;
    margin-left: auto;
    margin-right: auto;
    font-size: 1.05em;
    line-height: 1.5em;
    text-align: justify;
    text-justify: distribute;
}

@media only screen and (max-width: 860px) {
    section {
        width: calc(100vw - 60px);
    }
}

h1, h2, h3, h4 {
    font-family: 'Roboto', sans-serif;
    font-weight: bold;
    color: rgb(10, 10, 60);
    text-justify: none;
}

h1, h2 {
    font-size: 2em;
}

h3 {
    font-size: 1.3em;
}

code {
    font-family: 'Roboto Mono';
    font-size: 0.9em;
}

.kw {
    font-weight: bold;
}

th {
    text-align: center;
}

blockquote {
    border-left: 3px solid green;
    padding-left: 20px;
    margin-left: 0;
    color: darkgreen;
}

div#toc ul {
    list-style: none;
}
div#toc>ul {
    padding-left: 0;
}

        </style>
    </head>
    <body>
        <header>
            <span id="title" class=white> Heterogeneous Lists </span>
            <span id="subtitle" class=white> And How To Make Them </span>
        </header>
        <section>

<div id="toc">
<h3> Table Of Contents </h3>
<ul>
<li><a href="#the-bad-approach">The bad approach</a></li>
<li><a href="#the-good-approach">The good approach</a></li>
</ul>
</div>
<p>In object-oriented languages, it is common to have collections containing objects that implement a certain interface.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode cs"><code class="sourceCode cs"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw">interface</span> Animal { ... }</a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="kw">class</span> Cat: Animal { ... }</a>
<a class="sourceLine" id="cb1-3" data-line-number="3"><span class="kw">class</span> Dog: Animal { ... }</a>
<a class="sourceLine" id="cb1-4" data-line-number="4"></a>
<a class="sourceLine" id="cb1-5" data-line-number="5">List&lt;Animal&gt; listOfAnimals = ...;</a></code></pre></div>
<p>And while this is certainly possible in rust by using trait-objects,</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode rust"><code class="sourceCode rust"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="kw">trait</span> Animal <span class="op">{</span> ... <span class="op">}</span></a>
<a class="sourceLine" id="cb2-2" data-line-number="2"></a>
<a class="sourceLine" id="cb2-3" data-line-number="3"><span class="kw">let</span> list_of_animals: <span class="dt">Vec</span>&lt;&amp;Animal&gt; = ...;</a>
<a class="sourceLine" id="cb2-4" data-line-number="4"><span class="co">// or</span></a>
<a class="sourceLine" id="cb2-5" data-line-number="5"><span class="kw">let</span> list_of_animals: <span class="dt">Vec</span>&lt;<span class="dt">Box</span>&lt;Animal&gt;&gt; = ...;</a></code></pre></div>
<p>it is frowned upon due for stylistic as well as performance reasons: each method call from here-on-out will be invoked via interface dispatch.</p>
<p>I recently encountered a problem that <em>could</em> be solved by using a vec of trait objects, but due to performance concerns, I couldn’t afford the performance penalty.</p>
<p>Fortunately, the types of the objects in my list are known at compile-time, and the number of the items in the list stays constant, so I thought I’d try to work my way around this by way of a heterogeneous queue that constructs a specialized type for each instance of the list.</p>
<h2 id="the-bad-approach">The bad approach</h2>
<p>For comparisons sake, here’s a rough outline of what I had <em>before</em> using trait objects.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode rust"><code class="sourceCode rust"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="kw">trait</span> Shape <span class="op">{</span> .. <span class="op">}</span></a>
<a class="sourceLine" id="cb3-2" data-line-number="2"></a>
<a class="sourceLine" id="cb3-3" data-line-number="3"><span class="co">// `process(..)` makes a *lot* of method calls on `shape`, so having</span></a>
<a class="sourceLine" id="cb3-4" data-line-number="4"><span class="co">// this trait object as a parameter kills perf.</span></a>
<a class="sourceLine" id="cb3-5" data-line-number="5"><span class="kw">fn</span> process(shape: &amp;Shape) <span class="op">{</span> .. <span class="op">}</span></a>
<a class="sourceLine" id="cb3-6" data-line-number="6"></a>
<a class="sourceLine" id="cb3-7" data-line-number="7"><span class="kw">fn</span> main() <span class="op">{</span></a>
<a class="sourceLine" id="cb3-8" data-line-number="8">    <span class="kw">let</span> coll: <span class="dt">Vec</span>&lt;&amp;Shape&gt; = <span class="pp">vec!</span><span class="op">[</span> .., .., .., .. <span class="op">]</span>;</a>
<a class="sourceLine" id="cb3-9" data-line-number="9"></a>
<a class="sourceLine" id="cb3-10" data-line-number="10">    <span class="kw">for</span> obj <span class="kw">in</span> coll <span class="op">{</span></a>
<a class="sourceLine" id="cb3-11" data-line-number="11">        process(obj);</a>
<a class="sourceLine" id="cb3-12" data-line-number="12">    <span class="op">}</span></a>
<a class="sourceLine" id="cb3-13" data-line-number="13"><span class="op">}</span></a></code></pre></div>
<h2 id="the-good-approach">The good approach</h2>
<div class="sourceCode" id="cb4"><pre class="sourceCode rust"><code class="sourceCode rust"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="kw">trait</span> Shape <span class="op">{</span> .. <span class="op">}</span></a>
<a class="sourceLine" id="cb4-2" data-line-number="2"></a>
<a class="sourceLine" id="cb4-3" data-line-number="3"><span class="co">// Generic function, no longer goes through interface dispatch.</span></a>
<a class="sourceLine" id="cb4-4" data-line-number="4"><span class="kw">fn</span> process&lt;S: Shape&gt;(shape: &amp;S) <span class="op">{</span> .. <span class="op">}</span></a>
<a class="sourceLine" id="cb4-5" data-line-number="5"></a>
<a class="sourceLine" id="cb4-6" data-line-number="6"><span class="kw">trait</span> ShapeList&lt;T: Shape&gt; <span class="op">{</span></a>
<a class="sourceLine" id="cb4-7" data-line-number="7">    <span class="kw">fn</span> apply(&amp;<span class="kw">self</span>);</a>
<a class="sourceLine" id="cb4-8" data-line-number="8"><span class="op">}</span></a>
<a class="sourceLine" id="cb4-9" data-line-number="9"></a>
<a class="sourceLine" id="cb4-10" data-line-number="10"><span class="kw">struct</span> ShapeNil&lt;T: Shape&gt; <span class="op">{</span> <span class="op">}</span></a>
<a class="sourceLine" id="cb4-11" data-line-number="11"></a>
<a class="sourceLine" id="cb4-12" data-line-number="12"><span class="kw">struct</span> ShapeCons&lt;T: Shape, N: ShapeList&lt;T&gt;&gt; <span class="op">{</span></a>
<a class="sourceLine" id="cb4-13" data-line-number="13">    shape: T,</a>
<a class="sourceLine" id="cb4-14" data-line-number="14">    next: N</a>
<a class="sourceLine" id="cb4-15" data-line-number="15"><span class="op">}</span></a>
<a class="sourceLine" id="cb4-16" data-line-number="16"></a>
<a class="sourceLine" id="cb4-17" data-line-number="17"><span class="kw">impl</span> &lt;T&gt; ShapeList&lt;T&gt; <span class="kw">for</span> ShapeNil&lt;T&gt; <span class="op">{</span></a>
<a class="sourceLine" id="cb4-18" data-line-number="18">    <span class="kw">fn</span> apply(&amp;<span class="kw">self</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb4-19" data-line-number="19">        <span class="co">// do nothing, we&#39;ve reached the end</span></a>
<a class="sourceLine" id="cb4-20" data-line-number="20">    <span class="op">}</span></a>
<a class="sourceLine" id="cb4-21" data-line-number="21"><span class="op">}</span></a>
<a class="sourceLine" id="cb4-22" data-line-number="22"></a>
<a class="sourceLine" id="cb4-23" data-line-number="23"><span class="kw">impl</span> &lt;T, N&gt; ShapeList&lt;T&gt; <span class="kw">for</span> ShapeCons&lt;T, N&gt; <span class="op">{</span></a>
<a class="sourceLine" id="cb4-24" data-line-number="24">    <span class="kw">fn</span> apply(&amp;<span class="kw">self</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb4-25" data-line-number="25">        <span class="co">// Process yourself</span></a>
<a class="sourceLine" id="cb4-26" data-line-number="26">        process(&amp;<span class="kw">self</span>.shape);</a>
<a class="sourceLine" id="cb4-27" data-line-number="27">        <span class="co">// Then tell the next link to process itself</span></a>
<a class="sourceLine" id="cb4-28" data-line-number="28">        next.apply();</a>
<a class="sourceLine" id="cb4-29" data-line-number="29">    <span class="op">}</span></a>
<a class="sourceLine" id="cb4-30" data-line-number="30"><span class="op">}</span></a></code></pre></div>

<script>
    var maths = document.querySelectorAll(".math");
    for (var i = 0; i < maths.length; i++) {
        var text = maths[i].innerText;
        maths[i].innerText = "";
        katex.render(text, maths[i]);
    }
</script>

</section>
</body>

</html>


